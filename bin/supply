#!/bin/bash

set -e

cache_path=$2
deps_path=$3
idx=$4

echo "Fetching Hashicorp Vault package..."

wget -q -O $cache_path/vault.zip https://releases.hashicorp.com/vault/1.3.0/vault_1.3.0_linux_amd64.zip

unzip $cache_path/vault.zip -d $deps_path

mkdir -p /tmp/deps/$idx/profile.d

mkdir -p /tmp/app/profile.d

cat << EOF > /tmp/deps/$idx/config.yml
name: vault-buildpack
EOF

cat << EOF > /tmp/app/profile.d/0000-vault.sh
#!/bin/bash

set -e

echo "ASDASDASDSADA" > /tmp/tester

echo "Running Vault init..."

if [ -z \$VAULT_ADDR ]; then
  echo "Skipping due to missing VAULT_ADDR"
  exit
fi

if [ -z \$VAULT_ROLE ]; then
  echo "Skipping due to missing VAULT_ROLE"
  exit
fi

\$HOME/deps/vault login -method=cf role=\$VAULT_ROLE
EOF

chmod +x /tmp/app/profile.d/0000-vault.sh