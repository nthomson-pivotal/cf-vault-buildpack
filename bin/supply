#!/bin/bash

set -e

cache_path=$2
deps_path=$3
idx=$4

echo "Fetching Hashicorp Vault package..."

wget -q -O $cache_path/vault.zip https://releases.hashicorp.com/vault/1.3.0/vault_1.3.0_linux_amd64.zip

unzip $cache_path/vault.zip -d $deps_path

mkdir -p /tmp/deps/$idx/profile.d

cat << EOF > /tmp/deps/$idx/config.yml
name: vault-buildpack
EOF

cat << EOF > /tmp/app/profile.d/0000-vault.sh
if [ -z $VAULT_ADDR ]; then
  exit
fi

chmod +x /tmp/app/profile.d/0000-vault.sh

if [ -z $VAULT_ROLE ]; then
  exit
fi

$HOME/deps/vault login -method=cf role=$VAULT_ROLE
EOF